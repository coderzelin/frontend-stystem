### 浏览器安全

#### 同源策略

如果两个 URL 的协议，域名，端口号都相同，则这两个 URL 同源，同源策略会隔离不同源的 DOM 操作、页面数据、网络通信，进而实现 web 页面的安全

#### 安全和便利性的权衡

如果要绝对的安全就要牺牲便利性，因此需要在二者之前找到平衡点，也就是页面安全策略原型，具有下面的特点：

1. 页面可以引用第三方资源，不过也暴露了很多如 XSS 安全问题，所以又引入 CSP 来限制其自由程度
2. 使用 XMLHttpRequest 和 Fetch 都是无法直接进行跨域请求，因此引入了跨域资源共享策略（CORS），让其可以安全的进行跨域操作
3. 两个不同源的 DOM 是不能相互操纵的，因此，浏览器又实现了跨文档消息机制，可以通过 window.postMessage 的 js 接口和不同源的 DOM 通信

---

### CSP（内容安全策略）

CSP 的核心思想是让服务器决定浏览器能够加载那些资源，让服务器决定浏览器是否能执行内联 javascript 代码，可以通过 HTTP 响应头设置，或者 meta 属性设置如 `<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">`

```js
Content-Security-Policy: policy
```

---

### CORS

实现 CORS 通信的关键是服务器，只要服务器实现了 CORS 接口，就可以跨源通信，浏览器将 CORS 请求分成简单请求和非简单请求

简单请求需要同时满足下面两大条件

1. 请求方法是下面三种方法之一
   - HEAD
   - GET
   - POST
2. HTTP 头信息不超出以下字段
   - Accept
   - Accept-Language
   - Content-Language
   - Content-Type: 只限于 application/x-www-form-urlencoded、multipart/form-data、text/plain

如果不能同时满足上面两个条件的都属于非简单请求

#### 简单请求

对于简单请求，浏览器会带上 origin 字段，用来说明本次请求来自哪个源（协议+域名+端口号）。服务器根据这个值决定是否同意这次请求

如果 origin 指定的源不在许可范围内，会返回一个正常的 HTTP 响应，响应头没有 Access-Control-Allow-Origin 字段，状态码有可能是 200

如果 origin 指定的源在许可范围内，服务器返回的响应头会多出几个字段

```
Access-Control-Allow-Origin: http://api.bob.com
Access-Control-Allow-Credentials: true
Access-Control-Expose-Headers: FooBar
```

- Access-Control-Allow-Origin: 这个字段是必须的，是 \* 号和 origin 源
- Access-Control-Allow-Credentials: 可选，布尔值，表示是否发送 Cookie 给服务器，默认是不会发送的
- Access-Control-Expose-Headers: 可选，cors 请求时，xhr 对象的 getResponseHeader() 方法只能拿到 6 个基本字段，Cache-Control、Content-Language、Content-Type、Expries、Last-Modified、Pragma。如果想拿到其他字段，就必须在 Access-Control-Expose-Headers 中指定。上面指定，getResponseHeader('FooBar') 可以拿到 FooBar 字段

withCredentials

默认 cors 请求不会发送 cookie 给服务器，所以一方面需要指定 Access-Control-Allow-Credentials: true，另一方面需要开发者在 ajax 请求中开启 withCredentials 属性。

```js
var xhr = new XMLHttpRequest();
xhr.withCredentials = true;
```

如果需要发送 cookie，Access-Control-Allow-Origin 不能设置为 \*，必须指定与请求源一样的域名

#### 非简单请求

对于非简单请求，会先发送一个预检的请求（preflight）,浏览器会询问服务器，请求源是否在服务器许可的范围内，以及可以使用的 HTTP 方法和头信息，只有得到肯定的回复，才会发送正式的 xhr 请求

预检请求的方法是 OPTIONS。关键字段是 origin

```
OPTIONS /cors HTTP/1.1
Origin: http://api.bob.com
Access-Control-Request-Method: PUT
Access-Control-Request-Headers: X-Custom-Header
Host: api.alice.com
Accept-Language: en-US
Connection: keep-alive
User-Agent: Mozilla/5.0...
```

Access-Control-Request-Method: 该字段是必须的，用来指明 cors 请求会用到哪些 HTTP 方法

Access-Control-Request-Headers: cors 请求额外发送的请求头

预检请求通过之后服务器回回应的字段，以后的每次 cors 请求都会带上 origin 字段

```
Access-Control-Allow-Methods: GET, POST, PUT
Access-Control-Allow-Headers: X-Custom-Header
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 1728000
```

---

### 跨域
